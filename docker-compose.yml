x-db-environment: &x-db-environment
  POSTGRES_SSL_MODE: "disable"
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "cs2_skins"
  POSTGRES_PASSWORD: "cs2_secure_pass_2024"
  POSTGRES_USER: "cs2_user"

x-app-environment: &x-app-environment
  # App
  APP_NAME: "kedr891/cs-parser"
  APP_VERSION: "1.0.0"
  # HTTP settings
  HTTP_PORT: "8080"
  # Logger
  LOG_LEVEL: "debug"
  # PostgreSQL
  PG_POOL_MAX: "10"
  PG_URL: "postgres://cs2_user:cs2_secure_pass_2024@postgres:5432/cs2_skins?sslmode=disable"
  # Redis
  REDIS_ADDR: "redis:6379"
  REDIS_PASSWORD: ""
  REDIS_DB: "0"
  # Kafka
  KAFKA_BROKERS: "kafka:9092"
  KAFKA_TOPIC_PRICE_UPDATED: "skin.price.updated"
  KAFKA_TOPIC_SKIN_DISCOVERED: "skin.discovered"
  KAFKA_TOPIC_PRICE_ALERT: "notification.price_alert"
  KAFKA_GROUP_PRICE_CONSUMER: "price-consumer-group"
  KAFKA_GROUP_NOTIFICATION: "notification-consumer-group"
  # JWT
  JWT_SECRET: "your-secret-key-change-in-production"
  JWT_EXPIRATION_HOURS: "168"
  # Parser settings
  PARSER_INTERVAL_MINUTES: "5"
  PARSER_RATE_LIMIT_PER_MINUTE: "60"
  # Metrics
  METRICS_ENABLED: "true"
  # RabbitMQ
  RMQ_URL: "amqp://guest:guest@cs2_rabbitmq:5672/"
  # NATS
  NATS_URL: "nats://cs2_nats:4222/"
  # Swagger
  SWAGGER_ENABLED: "true"

services:
  postgres:
    container_name: cs2_postgres
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network

  redis:
    container_name: cs2_redis
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network

  zookeeper:
    container_name: cs2_zookeeper
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - cs2_network

  kafka:
    container_name: cs2_kafka
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - kafka_data:/var/lib/kafka/data
    ports:
      - "29092:29092"
    networks:
      - cs2_network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  rabbitmq:
    container_name: cs2_rabbitmq
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - cs2_network

  nats:
    container_name: cs2_nats
    image: nats:latest
    ports:
      - "4222:4222"
    networks:
      - cs2_network

  parser:
    container_name: cs2_parser
    build:
      context: .
      dockerfile: Dockerfile.parser
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  price-consumer:
    container_name: cs2_price_consumer
    build:
      context: .
      dockerfile: Dockerfile.price-consumer
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  api:
    container_name: cs2_api
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      <<: *x-app-environment
      SWAGGER_ENABLED: "true"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  notification:
    container_name: cs2_notification
    build:
      context: .
      dockerfile: Dockerfile.notification
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

networks:
  cs2_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  zookeeper_data:
  zookeeper_logs:
  kafka_data: