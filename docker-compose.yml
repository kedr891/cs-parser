x-db-environment: &x-db-environment
  POSTGRES_SSL_MODE: "disable"
  POSTGRES_DB: "cs2_skins"
  POSTGRES_PASSWORD: "cs2_secure_pass_2024"
  POSTGRES_USER: "cs2_user"

x-app-environment: &x-app-environment
  # App
  APP_NAME: "kedr891/cs-parser"
  APP_VERSION: "1.0.0"
  # HTTP settings
  HTTP_PORT: "8080"
  # Logger
  LOG_LEVEL: "debug"
  # PostgreSQL (без шардирования)
  SKIP_MIGRATIONS: "true"
  
  PG_POOL_MAX: "10"
  PG_URL: "postgres://cs2_user:cs2_secure_pass_2024@postgres:5432/cs2_skins?sslmode=disable"
  # Sharding
  SHARD_ENABLED: "true"
  SHARD_URLS: "postgres://cs2_user:cs2_secure_pass_2024@postgres_shard_pistols:5432/cs2_skins?sslmode=disable,postgres://cs2_user:cs2_secure_pass_2024@postgres_shard_rifles:5432/cs2_skins?sslmode=disable,postgres://cs2_user:cs2_secure_pass_2024@postgres_shard_other:5432/cs2_skins?sslmode=disable"
  # Redis
  REDIS_ADDR: "redis:6379"
  REDIS_PASSWORD: ""
  REDIS_DB: "0"
  # Kafka
  KAFKA_BROKERS: "kafka:9092"
  KAFKA_TOPIC_PRICE_UPDATED: "skin.price.updated"
  KAFKA_TOPIC_SKIN_DISCOVERED: "skin.discovered"
  KAFKA_TOPIC_PRICE_ALERT: "notification.price_alert"
  KAFKA_GROUP_PRICE_CONSUMER: "price-consumer-group"
  # Parser settings
  PARSER_INTERVAL_MINUTES: "5"
  PARSER_RATE_LIMIT_PER_MINUTE: "60"
  # Metrics
  METRICS_ENABLED: "true"
  # Swagger
  SWAGGER_ENABLED: "true"

services:
  # PostgreSQL - основная БД(без шардирования)
  postgres:
    container_name: cs2_postgres
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network

  # PostgreSQL Shard pistols
  postgres_shard_pistols:
    container_name: cs2_postgres_pistols
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
    volumes:
      - postgres_pistols_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network
    profiles:
      - sharding

  # PostgreSQL Shard rifles
  postgres_shard_rifles:
    container_name: cs2_postgres_rifles
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
    volumes:
      - postgres_rifles_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network
    profiles:
      - sharding

  # PostgreSQL Shard other
  postgres_shard_other:
    container_name: cs2_postgres_other
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
    volumes:
      - postgres_other_data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network
    profiles:
      - sharding

  # Redis
  redis:
    container_name: cs2_redis
    image: redis:8-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network
  kafka:
    container_name: cs2_kafka
    image: confluentinc/cp-kafka:8.1.1
    environment:
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@cs2_kafka:9093"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - kafka_data:/var/lib/kafka/data
    ports:
      - "9092:9092"
    networks:
      - cs2_network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Kafka Topics Initializer
  kafka-init:
    container_name: cs2_kafka_init
    image: confluentinc/cp-kafka:8.1.1
    depends_on:
      kafka:
        condition: service_healthy
    command: |
      bash -c "
      echo 'Waiting for Kafka to be ready...'
      sleep 10
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic skin.price.updated --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic skin.discovered --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification.price_alert --partitions 3 --replication-factor 1
      echo 'Topics created:'
      kafka-topics --bootstrap-server kafka:9092 --list
      "
    networks:
      - cs2_network
    profiles:
      - sharding

  # AKHQ - Kafka UI
  akhq:
    container_name: cs2_akhq
    image: tchiotludo/akhq:latest
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            cs2-kafka:
              properties:
                bootstrap.servers: "kafka:9092"
              schema-registry:
                url: ""
              connect:
                - name: ""
                  url: ""
    ports:
      - "8081:8080"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  # API service
  api:
    container_name: cs2_api
    build:
      context: .
      dockerfile: Dockerfile
    command: ["/app/bin/api"]
    environment:
      configPath: /app/config.yaml
      swaggerPath: /app/internal/pb/swagger/skins_api/skins.swagger.json
    volumes:
      - ./config.yaml:/app/config.yaml
    ports:
      - "8080:8080"
      - "50051:50051"
    depends_on:
      postgres_shard_pistols:
        condition: service_healthy
      postgres_shard_rifles:
        condition: service_healthy
      postgres_shard_other:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped
    profiles:
      - sharding

networks:
  cs2_network:
    driver: bridge

volumes:
  postgres_data:
  postgres_pistols_data:
  postgres_rifles_data:
  postgres_other_data:
  redis_data:
  kafka_data: