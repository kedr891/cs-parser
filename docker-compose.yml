x-db-environment: &x-db-environment
  POSTGRES_SSL_MODE: "disable"
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "cs2_skins"
  POSTGRES_PASSWORD: "cs2_secure_pass_2024"
  POSTGRES_USER: "cs2_user"

x-app-environment: &x-app-environment
  # App
  APP_NAME: "kedr891/cs-parser"
  APP_VERSION: "1.0.0"
  # HTTP settings
  HTTP_PORT: "8080"
  # Logger
  LOG_LEVEL: "debug"
  # PostgreSQL
  PG_POOL_MAX: "10"
  PG_URL: "postgres://cs2_user:cs2_secure_pass_2024@postgres:5432/cs2_skins?sslmode=disable"
  # Redis
  REDIS_ADDR: "redis:6379"
  REDIS_PASSWORD: ""
  REDIS_DB: "0"
  # Kafka
  KAFKA_BROKERS: "kafka:9092"
  KAFKA_TOPIC_PRICE_UPDATED: "skin.price.updated"
  KAFKA_TOPIC_SKIN_DISCOVERED: "skin.discovered"
  KAFKA_TOPIC_PRICE_ALERT: "notification.price_alert"
  KAFKA_GROUP_PRICE_CONSUMER: "price-consumer-group"
  KAFKA_GROUP_NOTIFICATION: "notification-consumer-group"
  # JWT
  JWT_SECRET: "your-secret-key-change-in-production"
  JWT_EXPIRATION_HOURS: "168"
  # Parser settings
  PARSER_INTERVAL_MINUTES: "5"
  PARSER_RATE_LIMIT_PER_MINUTE: "60"
  # Metrics
  METRICS_ENABLED: "true"
  # Swagger
  SWAGGER_ENABLED: "true"

services:
  # PostgreSQL
  postgres:
    container_name: cs2_postgres
    image: postgres:18-alpine
    environment:
      <<: *x-db-environment
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cs2_user -d cs2_skins"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network

  # Redis
  redis:
    container_name: cs2_redis
    image: redis:8-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cs2_network

  # Kafka в режиме KRaft (без Zookeeper)
  kafka:
    container_name: cs2_kafka
    image: confluentinc/cp-kafka:8.1.1
    environment:
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@cs2_kafka:9093"
      KAFKA_NUM_PARTITIONS: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - kafka_data:/var/lib/kafka/data
    ports:
      - "9092:9092"
    networks:
      - cs2_network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Parser service
  parser:
    container_name: cs2_parser
    build:
      context: .
      dockerfile: Dockerfile.parser
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  # Price consumer
  price-consumer:
    container_name: cs2_price_consumer
    build:
      context: .
      dockerfile: Dockerfile.price-consumer
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  # Notification service
  notification:
    container_name: cs2_notification
    build:
      context: .
      dockerfile: Dockerfile.notification
    environment:
      <<: *x-app-environment
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

  # API service
  api:
    container_name: cs2_api
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      <<: *x-app-environment
      SWAGGER_ENABLED: "true"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - cs2_network
    restart: unless-stopped

networks:
  cs2_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  kafka_data:
